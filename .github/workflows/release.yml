name: Release & Publish

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2

      - run: bun install --frozen-lockfile

      - name: Typecheck
        run: bun run typecheck

      - name: Lint
        run: bun run lint

      - name: Test
        run: bun run test

      - name: Build
        run: bun run build

      - name: Web-ext lint
        run: bunx web-ext lint --source-dir dist --warnings-as-errors=false

  build:
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2

      - run: bun install --frozen-lockfile

      - name: Build extension
        run: bun run build

      - name: Create zip
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          cd dist && zip -r ../fuzzy-history-search-${VERSION}.zip . -x "*.DS_Store"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension-zip
          path: "*.zip"

  publish-firefox:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2

      - run: bun install --frozen-lockfile

      - name: Build extension
        run: bun run build

      - name: Submit to Firefox (listed)
        run: |
          bunx web-ext sign \
            --channel=listed \
            --amo-metadata=amo-metadata.json \
            --api-key="${{ secrets.AMO_JWT_ISSUER }}" \
            --api-secret="${{ secrets.AMO_JWT_SECRET }}" \
            --timeout=120000 \
            --source-dir dist || echo "Submitted to AMO (approval pending)"

  publish-chrome:
    needs: build
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: extension-zip

      - name: Upload to Chrome Web Store
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          ZIP="fuzzy-history-search-${VERSION}.zip"

          # Get access token
          TOKEN=$(curl -s -X POST https://oauth2.googleapis.com/token \
            -d "client_id=${{ secrets.CHROME_CLIENT_ID }}" \
            -d "client_secret=${{ secrets.CHROME_CLIENT_SECRET }}" \
            -d "refresh_token=${{ secrets.CHROME_REFRESH_TOKEN }}" \
            -d "grant_type=refresh_token" | python3 -c "import sys,json; print(json.load(sys.stdin)['access_token'])")

          # Upload new version
          UPLOAD=$(curl -s -X PUT \
            "https://www.googleapis.com/upload/chromewebstore/v1.1/items/${{ secrets.CHROME_EXTENSION_ID }}" \
            -H "Authorization: Bearer $TOKEN" \
            -H "x-goog-api-version: 2" \
            -T "$ZIP")
          echo "$UPLOAD"

          STATE=$(echo "$UPLOAD" | python3 -c "import sys,json; print(json.load(sys.stdin).get('uploadState','FAILURE'))")
          if [ "$STATE" != "SUCCESS" ]; then
            echo "Upload failed: $STATE"
            exit 1
          fi

          # Publish
          PUBLISH=$(curl -s -X POST \
            "https://www.googleapis.com/chromewebstore/v1.1/items/${{ secrets.CHROME_EXTENSION_ID }}/publish" \
            -H "Authorization: Bearer $TOKEN" \
            -H "x-goog-api-version: 2" \
            -H "Content-Length: 0")
          echo "$PUBLISH"

  github-release:
    needs: [publish-firefox, publish-chrome]
    if: always() && needs.publish-firefox.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: extension-zip

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: "*.zip"
